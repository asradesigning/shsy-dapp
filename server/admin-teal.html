<!--
 * SHSY-RB-2025-Team1
-->
<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>SHSY - Admin</title>
        <link
            rel="icon"
            href="https://shsycoin.com/wp-content/uploads/2025/04/cropped-200x200-1-32x32.gif"
            sizes="32x32"
        />
        <link
            rel="icon"
            href="https://shsycoin.com/wp-content/uploads/2025/04/cropped-200x200-1-192x192.gif"
            sizes="192x192"
        />
        <link
            rel="apple-touch-icon"
            href="https://shsycoin.com/wp-content/uploads/2025/04/cropped-200x200-1-180x180.gif"
        />
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            body {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
                    Roboto, sans-serif;
                background: linear-gradient(135deg, #d1e7fb 0%, #dffdff 100%);
            }
            .header {
                background: linear-gradient(
                    135deg,
                    #00ddeb 0%,
                    #046bd2 50%,
                    #00ddeb 100%
                );
                padding: 16px 16px;
                border-bottom: 1px solid #00ddeb;
                display: flex;
                flex-direction: column;
                gap: 12px;
            }
            .admin-title {
                display: flex;
                align-items: center;
                gap: 8px;
                font-size: 16px;
                font-weight: 600;
                color: white;
            }
            .status-badges {
                display: flex;
                gap: 8px;
                flex-wrap: wrap;
            }
            .status-badge {
                padding: 4px 8px;
                border-radius: 16px;
                font-size: 11px;
                font-weight: 500;
            }

            @media (min-width: 768px) {
                .header {
                    flex-direction: row;
                    justify-content: space-between;
                    align-items: center;
                    padding: 16px 24px;
                }
                .admin-title {
                    font-size: 18px;
                }
                .status-badges {
                    gap: 12px;
                }
                .status-badge {
                    padding: 4px 12px;
                    font-size: 12px;
                }
            }
            .status-online {
                background: #dcfce7;
                color: #166534;
            }
            .status-puzzles {
                background: #dbeafe;
                color: #1e40af;
            }
            .main-content {
                max-width: 1200px;
                margin: 0 auto;
                padding: 16px;
            }
            .welcome-section {
                margin-bottom: 24px;
            }
            .welcome-title {
                font-size: 20px;
                font-weight: 700;
                color: #1e293b;
                margin-bottom: 8px;
            }
            .welcome-subtitle {
                color: #64748b;
                font-size: 14px;
            }
            .stats-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 16px;
                margin-bottom: 24px;
            }
            .stat-card {
                background: rgba(255, 255, 255, 0.9);
                border-radius: 12px;
                padding: 16px;
                border-left: 4px solid #00ddeb;
                box-shadow: 0 4px 12px rgba(0, 221, 235, 0.15);
            }

            @media (min-width: 768px) {
                .main-content {
                    padding: 32px 24px;
                }
                .welcome-section {
                    margin-bottom: 32px;
                }
                .welcome-title {
                    font-size: 24px;
                }
                .welcome-subtitle {
                    font-size: 16px;
                }
                .stats-grid {
                    grid-template-columns: repeat(4, 1fr);
                    gap: 20px;
                    margin-bottom: 32px;
                }
                .stat-card {
                    padding: 20px;
                }
            }
            .stat-header {
                display: flex;
                align-items: center;
                gap: 8px;
                margin-bottom: 8px;
            }
            .stat-icon {
                font-size: 16px;
            }
            .stat-label {
                font-size: 14px;
                color: #64748b;
                font-weight: 500;
            }
            .stat-value {
                font-size: 24px;
                font-weight: 700;
                color: #1e293b;
            }
            .content-grid {
                display: grid;
                grid-template-columns: 1fr;
                gap: 16px;
                margin-bottom: 24px;
            }
            .puzzle-management {
                background: rgba(255, 255, 255, 0.9);
                border-radius: 12px;
                padding: 16px;
                box-shadow: 0 4px 12px rgba(0, 221, 235, 0.15);
            }
            .reward-settings {
                background: rgba(255, 255, 255, 0.9);
                border-radius: 12px;
                padding: 16px;
                box-shadow: 0 4px 12px rgba(0, 221, 235, 0.15);
            }

            @media (min-width: 768px) {
                .content-grid {
                    grid-template-columns: 2fr 1fr;
                    gap: 24px;
                    margin-bottom: 32px;
                }
                .puzzle-management {
                    padding: 24px;
                }
                .reward-settings {
                    padding: 24px;
                }
            }
            .section-header {
                display: flex;
                flex-direction: column;
                gap: 12px;
                margin-bottom: 20px;
            }
            .section-title {
                font-size: 14px;
                font-weight: 600;
                color: #1e293b;
            }
            .section-buttons {
                display: flex;
                flex-direction: column;
                gap: 8px;
                width: 100%;
            }
            .btn {
                padding: 8px 16px;
                border-radius: 6px;
                font-size: 14px;
                font-weight: 500;
                cursor: pointer;
                border: none;
                transition: all 0.2s ease;
                width: 100%;
            }

            @media (min-width: 768px) {
                .section-header {
                    flex-direction: row;
                    align-items: center;
                    gap: 8px;
                }
                .section-title {
                    font-size: 16px;
                }
                .section-buttons {
                    flex-direction: row;
                    margin-left: auto;
                    width: auto;
                }
                .btn {
                    width: auto;
                }
            }
            .btn-primary {
                background: #00ddeb;
                color: white;
            }
            .btn-primary:hover {
                background: #046bd2;
                transform: scale(1.1);
                box-shadow: 0 8px 20px rgba(0, 221, 235, 0.4);
            }
            .btn-secondary {
                background: #64748b;
                color: white;
            }
            .btn-secondary:hover {
                background: #475569;
            }
            .btn:disabled {
                background: #94a3b8;
                cursor: not-allowed;
            }
            .btn-save {
                background: #00ddeb;
                color: white;
                width: 100%;
                margin-top: 16px;
            }
            .btn-save:hover {
                background: #046bd2;
                transform: scale(1.1);
                box-shadow: 0 8px 20px rgba(0, 221, 235, 0.4);
            }
            .puzzle-item {
                padding: 16px;
                border: 1px solid rgba(0, 221, 235, 0.2);
                border-radius: 6px;
                margin-bottom: 12px;
            }
            .puzzle-question {
                font-weight: 500;
                margin-bottom: 8px;
            }
            .puzzle-options {
                font-size: 14px;
                color: #64748b;
                margin-bottom: 8px;
            }
            .puzzle-meta {
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            .puzzle-status {
                background: #dcfce7;
                color: #166534;
                padding: 2px 8px;
                border-radius: 12px;
                font-size: 12px;
                font-weight: 500;
            }
            .puzzle-actions {
                display: flex;
                gap: 4px;
            }
            .btn-icon {
                padding: 4px;
                border-radius: 4px;
                border: none;
                cursor: pointer;
                font-size: 12px;
            }
            .btn-edit {
                background: #f1f5f9;
                color: #64748b;
            }
            .btn-delete {
                background: #fee2e2;
                color: #dc2626;
            }
            .form-group {
                margin-bottom: 16px;
            }
            .form-label {
                display: block;
                margin-bottom: 4px;
                font-weight: 500;
                color: #374151;
                font-size: 14px;
            }
            .form-input {
                width: 100%;
                padding: 8px 12px;
                border: 1px solid #d1d5db;
                border-radius: 6px;
                font-size: 14px;
            }
            .form-hint {
                font-size: 12px;
                color: #6b7280;
                margin-top: 4px;
            }
            .limit-warning {
                background: rgba(0, 221, 235, 0.1);
                border: 1px solid #00ddeb;
                color: #046bd2;
                padding: 12px;
                border-radius: 6px;
                margin-bottom: 16px;
                font-size: 14px;
                text-align: center;
            }
            .leaderboard {
                background: rgba(255, 255, 255, 0.9);
                border-radius: 12px;
                padding: 24px;
                box-shadow: 0 4px 12px rgba(0, 221, 235, 0.15);
            }
            .leaderboard-header {
                display: flex;
                align-items: center;
                gap: 8px;
                margin-bottom: 20px;
            }
            .leaderboard-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 12px 0;
                border-bottom: 1px solid #f1f5f9;
            }
            .leaderboard-item:last-child {
                border-bottom: none;
            }
            .leaderboard-rank {
                font-weight: 600;
                color: #64748b;
                margin-right: 12px;
                width: 20px;
            }
            .leaderboard-user {
                flex: 1;
            }
            .leaderboard-name {
                font-weight: 500;
                color: #1e293b;
            }
            .leaderboard-wallet {
                font-size: 12px;
                color: #64748b;
            }
            .leaderboard-score {
                font-weight: 600;
                color: #00ddeb;
            }
            .modal {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 1000;
                align-items: center;
                justify-content: center;
                padding: 20px;
            }
            .modal-content {
                background: white;
                padding: 24px;
                border-radius: 12px;
                max-width: 600px;
                width: 100%;
                max-height: 90vh;
                overflow-y: auto;
                position: relative;
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            }
            .modal-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
            }
            .modal-title {
                font-size: 18px;
                font-weight: 600;
                color: #1e293b;
            }
            .close-btn {
                background: none;
                border: none;
                font-size: 24px;
                cursor: pointer;
                color: #64748b;
            }
            .form-textarea {
                width: 100%;
                padding: 8px 12px;
                border: 1px solid #d1d5db;
                border-radius: 6px;
                font-size: 14px;
                min-height: 80px;
                resize: vertical;
            }
            .file-input {
                width: 100%;
                padding: 8px 12px;
                border: 1px solid #d1d5db;
                border-radius: 6px;
                background: white;
            }

            /* Toggle Switch Styles */
            .toggle-switch {
                position: relative;
                display: inline-block;
                width: 60px;
                height: 34px;
                margin: 8px 0;
            }
            .toggle-switch input {
                opacity: 0;
                width: 0;
                height: 0;
            }
            .toggle-slider {
                position: absolute;
                cursor: pointer;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: #ccc;
                transition: 0.4s;
                border-radius: 34px;
            }
            .toggle-slider:before {
                position: absolute;
                content: "";
                height: 26px;
                width: 26px;
                left: 4px;
                bottom: 4px;
                background-color: white;
                transition: 0.4s;
                border-radius: 50%;
            }
            input:checked + .toggle-slider {
                background-color: #00ddeb;
            }
            input:checked + .toggle-slider:before {
                transform: translateX(26px);
            }

            /* Additional Responsive Styles for Admin Panel */
            @media (max-width: 768px) {
                .main-content {
                    padding: 12px;
                }
                
                .grid {
                    grid-template-columns: 1fr;
                    gap: 16px;
                }
                
                .card {
                    padding: 16px;
                    margin-bottom: 16px;
                }
                
                .form-group {
                    margin-bottom: 16px;
                }
                
                .form-group input,
                .form-group textarea,
                .form-group select {
                    font-size: 16px;
                    padding: 12px;
                }
                
                .btn {
                    padding: 12px 20px;
                    font-size: 14px;
                    width: 100%;
                    margin-bottom: 8px;
                }
                
                .btn-group {
                    flex-direction: column;
                    gap: 8px;
                }
                
                .btn-group .btn {
                    margin: 0;
                }
                
                .modal-content {
                    width: 95%;
                    margin: 20px auto;
                    max-height: 90vh;
                    overflow-y: auto;
                }
                
                .welcome-title {
                    font-size: 24px;
                }
                
                .welcome-subtitle {
                    font-size: 14px;
                }
                
                .stats-grid {
                    grid-template-columns: 1fr;
                    gap: 12px;
                }
                
                .stat-card {
                    padding: 16px;
                }
                
                .tab-nav {
                    flex-direction: column;
                    gap: 4px;
                }
                
                .tab-nav .tab {
                    text-align: center;
                    padding: 12px;
                }
                
                .table-container {
                    overflow-x: auto;
                }
                
                .table {
                    min-width: 600px;
                }
                
                .leaderboard-item {
                    flex-direction: column;
                    text-align: center;
                    gap: 8px;
                }
                
                .toggle-container {
                    flex-direction: column;
                    align-items: flex-start;
                    gap: 8px;
                }
            }

            @media (max-width: 480px) {
                .main-content {
                    padding: 8px;
                }
                
                .card {
                    padding: 12px;
                }
                
                .modal-content {
                    width: 98%;
                    margin: 10px auto;
                }
                
                .welcome-title {
                    font-size: 20px;
                }
                
                .btn {
                    padding: 10px 16px;
                    font-size: 13px;
                }
            }
        </style>
    </head>
    <body>
        <div class="header">
            <div class="admin-title">‚öôÔ∏è Admin Dashboard</div>
            <div class="status-badges">
                <span class="status-badge status-online"
                    >System Status: Online</span
                >
                <span
                    class="status-badge status-puzzles"
                    id="active-puzzles-badge"
                    >Active Puzzles: 0/2</span
                >
            </div>
        </div>

        <div class="main-content">
            <div class="welcome-section">
                <h1 class="welcome-title">Welcome to your Admin Panel!</h1>
                <p class="welcome-subtitle">
                    Guess, stake, win million-dollar rewards!
                </p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-icon">üë•</span>
                        <span class="stat-label">Total Users</span>
                    </div>
                    <div class="stat-value" id="totalUsers">Loading...</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-icon">üî•</span>
                        <span class="stat-label">Total Staked</span>
                    </div>
                    <div class="stat-value" id="totalStaked">Loading...</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-icon">üèÜ</span>
                        <span class="stat-label">Total Rewards</span>
                    </div>
                    <div class="stat-value" id="totalRewards">Loading...</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-icon">üß©</span>
                        <span class="stat-label">Active Puzzles</span>
                    </div>
                    <div class="stat-value" id="active-puzzle-count">1</div>
                </div>
            </div>

            <div class="content-grid">
                <div class="puzzle-management">
                    <div class="section-header">
                        <span>‚öôÔ∏è</span>
                        <span class="section-title">Puzzle Management</span>
                        <div class="section-buttons">
                            <button
                                class="btn btn-secondary"
                                onclick="refreshRiddles()"
                            >
                                üîÑ Refresh
                            </button>
                            <button
                                class="btn btn-secondary"
                                onclick="openBatchUploadModal()"
                            >
                                üìÅ Batch Upload
                            </button>
                            <button
                                class="btn btn-primary"
                                id="add-puzzle-btn"
                                onclick="openCreateModal()"
                            >
                                +Add Puzzle
                            </button>
                        </div>
                    </div>

                    <div id="riddles-container">
                        <div class="loading">Loading riddles...</div>
                    </div>
                </div>

                <div class="reward-settings">
                    <div class="section-header">
                        <span>üèÜ</span>
                        <span class="section-title">Reward Settings</span>
                    </div>

                    <div class="form-group">
                        <label class="form-label"
                            >APY for (30-day) lock period</label
                        >
                        <input
                            type="number"
                            id="apy-30-day"
                            class="form-input"
                            value="5"
                            min="0"
                            max="100"
                            step="0.1"
                        />
                        <div class="form-hint">Annual Percentage Yield (%)</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label"
                            >APY for (90-day) lock period</label
                        >
                        <input
                            type="number"
                            id="apy-90-day"
                            class="form-input"
                            value="7.5"
                            min="0"
                            max="100"
                            step="0.1"
                        />
                        <div class="form-hint">Annual Percentage Yield (%)</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label"
                            >APY for (180-day) lock period</label
                        >
                        <input
                            type="number"
                            id="apy-180-day"
                            class="form-input"
                            value="12"
                            min="0"
                            max="100"
                            step="0.1"
                        />
                        <div class="form-hint">Annual Percentage Yield (%)</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label"
                            >30d participation reward</label
                        >
                        <input
                            type="number"
                            id="participation-30d"
                            class="form-input"
                            value="10"
                            min="0"
                            max="1000"
                        />
                        <div class="form-hint">
                            SHSY tokens for 30-day participation
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label"
                            >10d participation reward</label
                        >
                        <input
                            type="number"
                            id="participation-10d"
                            class="form-input"
                            value="5"
                            min="0"
                            max="1000"
                        />
                        <div class="form-hint">
                            SHSY tokens for 10-day participation
                        </div>
                    </div>

                    <!-- Lock Settings Section -->
                    <div
                        style="
                            border-top: 2px solid #00ddeb;
                            margin: 20px 0;
                            padding-top: 20px;
                        "
                    >
                        <h3 style="color: #00ddeb; margin-bottom: 15px">
                            üîí Reward Lock Settings
                        </h3>

                        <div class="form-group">
                            <label class="form-label">Lock Percentage</label>
                            <input
                                type="number"
                                id="lock-percentage"
                                class="form-input"
                                value="25"
                                min="0"
                                max="100"
                            />
                            <div class="form-hint">
                                Percentage of all rewards to lock (0-100%)
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Lock Days</label>
                            <input
                                type="number"
                                id="lock-days"
                                class="form-input"
                                value="30"
                                min="1"
                                max="365"
                            />
                            <div class="form-hint">
                                Days to lock reward portions
                            </div>
                        </div>
                    </div>

                    <!-- Million Pool Settings Section -->
                    <div
                        style="
                            border-top: 2px solid #00ddeb;
                            margin: 20px 0;
                            padding-top: 20px;
                        "
                    >
                        <h3 style="color: #00ddeb; margin-bottom: 15px">
                            üí∞ Million Pool Settings
                        </h3>

                        <div class="form-group">
                            <label class="form-label">Pool Status</label>
                            <label class="toggle-switch">
                                <input
                                    type="checkbox"
                                    id="million-pool-active"
                                />
                                <span class="toggle-slider"></span>
                            </label>
                            <div class="form-hint">
                                Enable/disable the million dollar pool
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label"
                                >Distribution Frequency (minutes)</label
                            >
                            <input
                                type="number"
                                id="distribution-frequency"
                                class="form-input"
                                value="1440"
                                min="1"
                                max="10080"
                            />
                            <div class="form-hint">
                                How often rewards are distributed (1440 = 24
                                hours)
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label"
                                >Reward Amount (SHSY)</label
                            >
                            <input
                                type="number"
                                id="reward-amount-usdt"
                                class="form-input"
                                value="10.00"
                                min="0.01"
                                step="0.01"
                            />
                            <div class="form-hint">
                                SHSY amount distributed to each winner
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Number of Winners</label>
                            <input
                                type="number"
                                id="number-of-winners"
                                class="form-input"
                                value="5"
                                min="1"
                                max="100"
                            />
                            <div class="form-hint">
                                Number of randomly selected participants per
                                distribution
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">USDT Requirement</label>
                            <input
                                type="number"
                                id="usdt-requirement"
                                class="form-input"
                                value="4.00"
                                min="0.01"
                                step="0.01"
                            />
                            <div class="form-hint">
                                Minimum USDT deposit to participate
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">SHSY Requirement</label>
                            <input
                                type="number"
                                id="shsy-requirement"
                                class="form-input"
                                value="100.00"
                                min="1"
                                step="0.01"
                            />
                            <div class="form-hint">
                                Minimum SHSY staked to auto-qualify
                            </div>
                        </div>
                    </div>

                    <button class="btn btn-save" onclick="updateRewardRates()">
                        Save All Settings
                    </button>
                </div>
            </div>

            <div class="leaderboard">
                <div class="leaderboard-header">
                    <span>üèÜ</span>
                    <span class="section-title">Top Stakers</span>
                </div>

                <div id="leaderboard-content">
                    <div class="loading">Loading leaderboard...</div>
                </div>
            </div>
        </div>

        <!-- Create/Edit Riddle Modal -->
        <div id="riddle-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title" id="modal-title">
                        Create New Riddle
                    </h2>
                    <button class="close-btn" onclick="closeModal()">
                        &times;
                    </button>
                </div>

                <form id="riddle-form">
                    <div
                        style="
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 16px;
                        "
                    >
                        <div class="form-group">
                            <label class="form-label"
                                >Content (Chinese) *</label
                            >
                            <textarea
                                id="content-chinese"
                                class="form-textarea"
                                placeholder="Ë∞úÈ¢òÂÜÖÂÆπÔºà‰∏≠ÊñáÔºâ"
                                required
                            ></textarea>
                            <div class="form-hint">20-100 characters</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label"
                                >Content (English) *</label
                            >
                            <textarea
                                id="content-english"
                                class="form-textarea"
                                placeholder="Riddle content in English"
                                required
                            ></textarea>
                            <div class="form-hint">20-100 characters</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Answer *</label>
                        <input
                            type="text"
                            id="answer"
                            class="form-input"
                            placeholder="Correct answer"
                            required
                        />
                        <div class="form-hint">
                            The correct answer (case-insensitive)
                        </div>
                    </div>

                    <div
                        style="
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 16px;
                        "
                    >
                        <div class="form-group">
                            <label class="form-label">Hint (Chinese)</label>
                            <textarea
                                id="hint-chinese"
                                class="form-textarea"
                                placeholder="ÊèêÁ§∫Ôºà‰∏≠ÊñáÔºåÂèØÈÄâÔºâ"
                            ></textarea>
                            <div class="form-hint">
                                Max 100 characters (optional)
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Hint (English)</label>
                            <textarea
                                id="hint-english"
                                class="form-textarea"
                                placeholder="Hint in English (optional)"
                            ></textarea>
                            <div class="form-hint">
                                Max 100 characters (optional)
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label"
                            >Multiple Choice Options (English) *</label
                        >
                        <div style="margin-top: 8px">
                            <input
                                type="text"
                                id="option-1"
                                class="form-input"
                                placeholder="Option A"
                                required
                                style="margin-bottom: 8px"
                            />
                            <input
                                type="text"
                                id="option-2"
                                class="form-input"
                                placeholder="Option B"
                                required
                                style="margin-bottom: 8px"
                            />
                            <input
                                type="text"
                                id="option-3"
                                class="form-input"
                                placeholder="Option C"
                                required
                                style="margin-bottom: 8px"
                            />
                            <input
                                type="text"
                                id="option-4"
                                class="form-input"
                                placeholder="Option D"
                                required
                            />
                        </div>
                        <div class="form-hint">
                            Provide exactly 4 options for multiple choice
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Image URL</label>
                        <input
                            type="url"
                            id="image-url"
                            class="form-input"
                            placeholder="https://example.com/image.jpg"
                        />
                        <div class="form-hint">PNG/JPG, max 2MB (optional)</div>
                    </div>

                    <div
                        style="
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 16px;
                        "
                    >
                        <div class="form-group">
                            <label class="form-label"
                                >Win Reward (SHSY) *</label
                            >
                            <input
                                type="number"
                                id="win-reward"
                                class="form-input"
                                min="5"
                                max="50"
                                value="10"
                                required
                            />
                            <div class="form-hint">5-50 SHSY tokens</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label"
                                >Participation Reward (SHSY) *</label
                            >
                            <input
                                type="number"
                                id="participation-reward"
                                class="form-input"
                                min="3"
                                max="5"
                                value="3"
                                required
                            />
                            <div class="form-hint">3-5 SHSY tokens</div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 12px; margin-top: 20px">
                        <button
                            type="button"
                            class="btn btn-secondary"
                            onclick="closeModal()"
                        >
                            Cancel
                        </button>
                        <button
                            type="submit"
                            class="btn btn-primary"
                            id="submit-btn"
                        >
                            Create Riddle
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Batch Upload Modal -->
        <div id="batch-upload-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Batch Upload Riddles</h2>
                    <button class="close-btn" onclick="closeBatchUploadModal()">
                        &times;
                    </button>
                </div>

                <div style="margin-bottom: 20px">
                    <p
                        style="
                            color: #64748b;
                            font-size: 14px;
                            margin-bottom: 12px;
                        "
                    >
                        Upload a CSV file with multiple riddles. All riddles
                        will be created as inactive.
                    </p>

                    <div
                        style="
                            background: #f8fafc;
                            border: 1px solid #e2e8f0;
                            border-radius: 8px;
                            padding: 16px;
                            margin-bottom: 16px;
                        "
                    >
                        <h4
                            style="
                                margin: 0 0 8px 0;
                                color: #374151;
                                font-size: 14px;
                                font-weight: 600;
                            "
                        >
                            CSV Format Required:
                        </h4>
                        <code
                            style="
                                font-size: 12px;
                                color: #1f2937;
                                display: block;
                                white-space: pre-line;
                            "
                            >contentChinese,contentEnglish,answer,hintChinese,hintEnglish,option1,option2,option3,option4,imageUrl,winReward,participationReward</code
                        >

                        <div style="margin-top: 12px">
                            <h5
                                style="
                                    margin: 0 0 4px 0;
                                    color: #374151;
                                    font-size: 13px;
                                    font-weight: 600;
                                "
                            >
                                Example Row:
                            </h5>
                            <code
                                style="
                                    font-size: 11px;
                                    color: #6b7280;
                                    display: block;
                                    word-break: break-all;
                                "
                            >
                                "‰ªÄ‰πàÊòØÊØîÁâπÂ∏ÅÁöÑÊúÄÂ§ß‰æõÂ∫îÈáèÔºü","What is the
                                maximum supply of Bitcoin?","21
                                million","ÊÉ≥ÊÉ≥Á®ÄÁº∫ÊÄß","Think about scarcity","21
                                million","100 million","50
                                million","Unlimited","",10,3
                            </code>
                        </div>
                    </div>

                    <div
                        style="
                            background: #fef3c7;
                            border: 1px solid #f59e0b;
                            border-radius: 8px;
                            padding: 12px;
                            margin-bottom: 16px;
                        "
                    >
                        <h4
                            style="
                                margin: 0 0 4px 0;
                                color: #92400e;
                                font-size: 13px;
                                font-weight: 600;
                            "
                        >
                            Important Notes:
                        </h4>
                        <ul
                            style="
                                margin: 0;
                                padding-left: 16px;
                                color: #92400e;
                                font-size: 12px;
                            "
                        >
                            <li>
                                Content must be 20-100 characters for both
                                languages
                            </li>
                            <li>
                                Hints are optional, maximum 100 characters if
                                provided
                            </li>
                            <li>All 4 options are required</li>
                            <li>
                                Win rewards: 5-50 SHSY, Participation rewards:
                                3-5 SHSY
                            </li>
                            <li>Image URL is optional</li>
                        </ul>
                    </div>
                </div>

                <form id="batch-upload-form">
                    <div class="form-group">
                        <label class="form-label">CSV File *</label>
                        <input
                            type="file"
                            id="csv-file"
                            class="form-input"
                            accept=".csv"
                            required
                            style="padding: 8px"
                        />
                        <div class="form-hint">
                            Select a CSV file with riddles data
                        </div>
                    </div>

                    <div
                        id="upload-progress"
                        style="display: none; margin: 16px 0"
                    >
                        <div
                            style="
                                background: #f3f4f6;
                                border-radius: 8px;
                                height: 8px;
                                overflow: hidden;
                            "
                        >
                            <div
                                id="progress-bar"
                                style="
                                    background: #10b981;
                                    height: 100%;
                                    width: 0%;
                                    transition: width 0.3s;
                                "
                            ></div>
                        </div>
                        <p
                            id="upload-status"
                            style="
                                margin: 8px 0 0 0;
                                font-size: 14px;
                                color: #6b7280;
                            "
                        ></p>
                    </div>

                    <div style="display: flex; gap: 12px; margin-top: 20px">
                        <button
                            type="button"
                            class="btn btn-secondary"
                            onclick="closeBatchUploadModal()"
                        >
                            Cancel
                        </button>
                        <button
                            type="submit"
                            class="btn btn-primary"
                            id="upload-btn"
                        >
                            Upload Riddles
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <script>
            let currentRiddles = [];
            let editingRiddleId = null;
            let activePuzzles = 0;

            // Initialize the page
            document.addEventListener("DOMContentLoaded", function () {
                loadAdminStats();
                refreshRiddles();
                refreshLeaderboard();
                loadRewardRates();
            });

            // API Functions
            async function apiRequest(url, options = {}) {
                try {
                    const response = await fetch(url, {
                        headers: {
                            "Content-Type": "application/json",
                            ...options.headers,
                        },
                        ...options,
                    });

                    if (!response.ok) {
                        throw new Error(
                            `HTTP ${response.status}: ${response.statusText}`,
                        );
                    }

                    return await response.json();
                } catch (error) {
                    console.error("API request failed:", error);
                    throw error;
                }
            }

            // Load admin statistics
            async function loadAdminStats() {
                try {
                    const data = await apiRequest("/api/admin/stats");
                    if (data.success) {
                        document.getElementById("totalUsers").textContent =
                            data.totalUsers;
                        document.getElementById("totalStaked").textContent =
                            data.totalStaked + " SHSY";
                        document.getElementById("totalRewards").textContent =
                            data.totalRewards + " SHSY";
                    }
                } catch (error) {
                    console.error("Failed to load admin stats:", error);
                }
            }

            // Load and display riddles
            async function refreshRiddles() {
                try {
                    const container =
                        document.getElementById("riddles-container");
                    container.innerHTML =
                        '<div class="loading">Loading riddles...</div>';

                    const data = await apiRequest("/api/admin/riddles");
                    currentRiddles = data.riddles || [];

                    activePuzzles = currentRiddles.filter(
                        (r) => r.status === "published",
                    ).length;
                    updatePuzzleLimit();
                    renderRiddles();
                } catch (error) {
                    console.error("Failed to load riddles:", error);
                    document.getElementById("riddles-container").innerHTML =
                        '<div style="text-align: center; padding: 20px; color: #dc2626;">Failed to load riddles. Please try again.</div>';
                }
            }

            // Update riddle statistics
            function updateRiddleStats(data) {
                const active = data.activePublishedCount || 0;
                document.getElementById("active-puzzle-count").textContent =
                    active;
            }

            // Render riddles in original format
            function renderRiddles() {
                const container = document.getElementById("riddles-container");

                if (currentRiddles.length === 0) {
                    container.innerHTML =
                        '<div style="text-align: center; padding: 20px; color: #64748b;">No riddles found. Create your first riddle!</div>';
                    return;
                }

                const riddlesHtml = currentRiddles
                    .map((riddle) => {
                        const isActive = riddle.status === "published";
                        const statusText = isActive ? "Active" : "Inactive";
                        const toggleText = isActive ? "Deactivate" : "Activate";

                        return `
                <div class="puzzle-item">
                    <div class="puzzle-question">${riddle.contentEnglish}</div>
                    <div class="puzzle-options">
                        ${riddle.optionsEnglish ? riddle.optionsEnglish.map((opt, i) => `(${String.fromCharCode(65 + i)}) ${opt}`).join("<br>") : ""}
                        ${riddle.hintEnglish ? `<br>üí° Hint: ${riddle.hintEnglish}` : ""}
                        <br><strong>Reward:</strong> ${riddle.winReward} SHSY
                    </div>
                    <div class="puzzle-meta">
                        <span class="puzzle-status">${statusText}</span>
                        <div class="puzzle-actions">
                            <button class="btn-icon ${isActive ? "btn-deactivate" : "btn-activate"}" 
                                    onclick="toggleRiddleStatus(${riddle.id}, '${isActive ? "deactivate" : "activate"}')"
                                    style="background: ${isActive ? "#dc2626" : "#16a34a"}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                                ${toggleText}
                            </button>
                            <button class="btn-icon btn-edit" onclick="editRiddle(${riddle.id})">‚úèÔ∏è</button>
                            <button class="btn-icon btn-delete" onclick="deleteRiddle(${riddle.id})">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
            `;
                    })
                    .join("");

                container.innerHTML = riddlesHtml;
            }

            // Update live count display
            function updateLiveCount(activeCount, totalCount) {
                const badge = document.getElementById("active-puzzles-badge");
                const statsCount = document.getElementById(
                    "active-puzzle-count",
                );

                badge.textContent = `Active Puzzles: ${activeCount}/2`;
                statsCount.textContent = activeCount;
            }

            // Toggle riddle activation status
            async function toggleRiddleStatus(riddleId, action) {
                try {
                    const activeCount = currentRiddles.filter(
                        (r) => r.status === "published",
                    ).length;

                    if (action === "activate" && activeCount >= 2) {
                        alert(
                            "Cannot activate more than 2 riddles at once. Please deactivate another riddle first.",
                        );
                        return;
                    }

                    const response = await apiRequest(
                        `/api/admin/riddles/${riddleId}/status`,
                        {
                            method: "PUT",
                            body: JSON.stringify({
                                action: action,
                            }),
                        },
                    );

                    if (response.success) {
                        alert(
                            `Riddle ${action === "activate" ? "activated" : "deactivated"} successfully!`,
                        );
                        refreshRiddles();
                    } else {
                        throw new Error(
                            response.error || `Failed to ${action} riddle`,
                        );
                    }
                } catch (error) {
                    alert(`Failed to ${action} riddle: ` + error.message);
                }
            }

            // Open create modal (no limits)
            function openCreateModal() {
                editingRiddleId = null;
                document.getElementById("modal-title").textContent =
                    "Create New Riddle";
                document.getElementById("submit-btn").textContent =
                    "Create Riddle";
                document.getElementById("riddle-form").reset();
                const modal = document.getElementById("riddle-modal");
                modal.style.display = "flex";
                document.body.style.overflow = "hidden";
            }

            // Edit riddle
            function editRiddle(riddleId) {
                const riddle = currentRiddles.find((r) => r.id === riddleId);
                if (!riddle) return;

                editingRiddleId = riddleId;
                document.getElementById("modal-title").textContent =
                    "Edit Riddle";
                document.getElementById("submit-btn").textContent =
                    "Update Riddle";

                // Fill form with riddle data
                document.getElementById("content-chinese").value =
                    riddle.contentChinese || "";
                document.getElementById("content-english").value =
                    riddle.contentEnglish || "";
                document.getElementById("answer").value = riddle.answer || "";
                document.getElementById("hint-chinese").value =
                    riddle.hintChinese || "";
                document.getElementById("hint-english").value =
                    riddle.hintEnglish || "";
                document.getElementById("image-url").value =
                    riddle.imageUrl || "";
                document.getElementById("win-reward").value =
                    riddle.winReward || 10;
                document.getElementById("participation-reward").value =
                    riddle.participationReward || 3;

                // Fill options
                const options = riddle.optionsEnglish || [];
                for (let i = 0; i < 4; i++) {
                    document.getElementById(`option-${i + 1}`).value =
                        options[i] || "";
                }

                const modal = document.getElementById("riddle-modal");
                modal.style.display = "flex";
                document.body.style.overflow = "hidden";
            }

            // Close modal
            function closeModal() {
                document.getElementById("riddle-modal").style.display = "none";
                document.body.style.overflow = "auto"; // Restore body scroll
                editingRiddleId = null;
            }

            // Handle form submission
            document
                .getElementById("riddle-form")
                .addEventListener("submit", async function (e) {
                    e.preventDefault();

                    // Get form values
                    const contentChinese = document
                        .getElementById("content-chinese")
                        .value.trim();
                    const contentEnglish = document
                        .getElementById("content-english")
                        .value.trim();
                    const answer = document
                        .getElementById("answer")
                        .value.trim();
                    const hintChinese = document
                        .getElementById("hint-chinese")
                        .value.trim();
                    const hintEnglish = document
                        .getElementById("hint-english")
                        .value.trim();
                    const imageUrl = document
                        .getElementById("image-url")
                        .value.trim();
                    const winReward = parseInt(
                        document.getElementById("win-reward").value,
                    );
                    const participationReward = parseInt(
                        document.getElementById("participation-reward").value,
                    );

                    const optionsEnglish = [
                        document.getElementById("option-1").value.trim(),
                        document.getElementById("option-2").value.trim(),
                        document.getElementById("option-3").value.trim(),
                        document.getElementById("option-4").value.trim(),
                    ];

                    // Enhanced validation
                    if (
                        !contentChinese ||
                        contentChinese.length < 20 ||
                        contentChinese.length > 100
                    ) {
                        alert(
                            "Chinese content is required and must be between 20-100 characters",
                        );
                        return;
                    }

                    if (
                        !contentEnglish ||
                        contentEnglish.length < 20 ||
                        contentEnglish.length > 100
                    ) {
                        alert(
                            "English content is required and must be between 20-100 characters",
                        );
                        return;
                    }

                    if (!answer) {
                        alert("Answer is required");
                        return;
                    }

                    if (optionsEnglish.some((opt) => !opt)) {
                        alert("All 4 options are required");
                        return;
                    }

                    if (isNaN(winReward) || winReward < 5 || winReward > 50) {
                        alert("Win reward must be between 5-50 SHSY");
                        return;
                    }

                    if (
                        isNaN(participationReward) ||
                        participationReward < 3 ||
                        participationReward > 5
                    ) {
                        alert("Participation reward must be between 3-5 SHSY");
                        return;
                    }

                    // Validate hints if provided (only check max length)
                    if (hintChinese && hintChinese.length > 100) {
                        alert(
                            "Chinese hint must be 100 characters or less if provided",
                        );
                        return;
                    }

                    if (hintEnglish && hintEnglish.length > 100) {
                        alert(
                            "English hint must be 100 characters or less if provided",
                        );
                        return;
                    }

                    const formData = {
                        contentChinese,
                        contentEnglish,
                        answer,
                        hintChinese: hintChinese || null,
                        hintEnglish: hintEnglish || null,
                        optionsEnglish,
                        imageUrl: imageUrl || null,
                        winReward,
                        participationReward,
                        duration: 172800,
                    };

                    try {
                        const submitBtn = document.getElementById("submit-btn");
                        submitBtn.disabled = true;
                        submitBtn.textContent = "Saving...";

                        console.log("Sending riddle data:", formData);

                        let response;
                        if (editingRiddleId) {
                            response = await apiRequest(
                                `/api/admin/riddles/${editingRiddleId}`,
                                {
                                    method: "PUT",
                                    body: JSON.stringify(formData),
                                },
                            );
                        } else {
                            response = await apiRequest("/api/admin/riddles", {
                                method: "POST",
                                body: JSON.stringify(formData),
                            });
                        }

                        alert(response.message || "Riddle saved successfully!");
                        closeModal();
                        refreshRiddles();
                    } catch (error) {
                        console.error("Error saving riddle:", error);
                        alert("Failed to save riddle: " + error.message);
                    } finally {
                        const submitBtn = document.getElementById("submit-btn");
                        submitBtn.disabled = false;
                        submitBtn.textContent = editingRiddleId
                            ? "Update Riddle"
                            : "Create Riddle";
                    }
                });

            // Delete riddle
            async function deleteRiddle(riddleId) {
                if (!confirm("Are you sure you want to delete this riddle?"))
                    return;

                try {
                    await apiRequest(`/api/admin/riddles/${riddleId}`, {
                        method: "DELETE",
                    });

                    alert("Riddle deleted successfully!");
                    refreshRiddles();
                } catch (error) {
                    alert("Failed to delete riddle: " + error.message);
                }
            }

            // Load and update reward rates
            async function loadRewardRates() {
                try {
                    const data = await apiRequest("/api/admin/reward-settings");
                    if (data.success) {
                        document.getElementById("apy-30-day").value =
                            data.settings.apy30Day || 5;
                        document.getElementById("apy-90-day").value =
                            data.settings.apy90Day || 7.5;
                        document.getElementById("apy-180-day").value =
                            data.settings.apy180Day || 12;
                        document.getElementById("participation-30d").value =
                            data.settings.participation30d || 10;
                        document.getElementById("participation-10d").value =
                            data.settings.participation10d || 5;
                    }
                } catch (error) {
                    console.error("Failed to load reward settings:", error);
                }
            }

            async function updateRewardRates() {
                try {
                    const apy30Day = parseFloat(
                        document.getElementById("apy-30-day").value,
                    );
                    const apy90Day = parseFloat(
                        document.getElementById("apy-90-day").value,
                    );
                    const apy180Day = parseFloat(
                        document.getElementById("apy-180-day").value,
                    );
                    const participation30d = parseInt(
                        document.getElementById("participation-30d").value,
                    );
                    const participation10d = parseInt(
                        document.getElementById("participation-10d").value,
                    );

                    // Validate APY rates (0-100%)
                    if (
                        apy30Day < 0 ||
                        apy30Day > 100 ||
                        apy90Day < 0 ||
                        apy90Day > 100 ||
                        apy180Day < 0 ||
                        apy180Day > 100
                    ) {
                        alert("APY rates must be between 0 and 100%");
                        return;
                    }

                    // Validate participation rewards (0-1000 SHSY)
                    if (
                        participation30d < 0 ||
                        participation30d > 1000 ||
                        participation10d < 0 ||
                        participation10d > 1000
                    ) {
                        alert(
                            "Participation rewards must be between 0 and 1000 SHSY",
                        );
                        return;
                    }

                    const response = await apiRequest(
                        "/api/admin/reward-settings",
                        {
                            method: "POST",
                            body: JSON.stringify({
                                apy30Day,
                                apy90Day,
                                apy180Day,
                                participation30d,
                                participation10d,
                            }),
                        },
                    );

                    if (response.success) {
                        alert("Reward settings updated successfully!");
                        loadRewardRates();
                    } else {
                        throw new Error(
                            response.error ||
                                "Failed to update reward settings",
                        );
                    }
                } catch (error) {
                    alert("Failed to update reward settings: " + error.message);
                }
            }

            // Load and display leaderboard
            async function refreshLeaderboard() {
                try {
                    const container = document.getElementById(
                        "leaderboard-content",
                    );
                    container.innerHTML =
                        '<div class="loading">Loading leaderboard...</div>';

                    const data = await apiRequest("/api/leaderboard");

                    if (data.success && data.leaderboard.length > 0) {
                        const leaderboardHtml = data.leaderboard
                            .slice(0, 10)
                            .map(
                                (user) => `
                        <div class="leaderboard-item">
                            <span class="leaderboard-rank">#${user.rank}</span>
                            <div class="leaderboard-user">
                                <div class="leaderboard-name">Staker ${user.rank}</div>
                                <div class="leaderboard-wallet">${user.walletAddress.substring(0, 8)}...${user.walletAddress.substring(-4)}</div>
                            </div>
                            <div class="leaderboard-score">${parseFloat(user.totalStaked).toLocaleString()} SHSY</div>
                        </div>
                    `,
                            )
                            .join("");

                        container.innerHTML = leaderboardHtml;
                    } else {
                        container.innerHTML =
                            '<div style="text-align: center; padding: 20px; color: #64748b; font-size: 14px;">No stakers yet</div>';
                    }
                } catch (error) {
                    console.error("Failed to load leaderboard:", error);
                    document.getElementById("leaderboard-content").innerHTML =
                        '<div style="text-align: center; padding: 20px; color: #dc2626; font-size: 14px;">Failed to load leaderboard</div>';
                }
            }

            // Batch Upload Functions
            function openBatchUploadModal() {
                const modal = document.getElementById("batch-upload-modal");
                modal.style.display = "flex";
                document.body.style.overflow = "hidden";
                document.getElementById("batch-upload-form").reset();
                document.getElementById("upload-progress").style.display =
                    "none";
            }

            function closeBatchUploadModal() {
                document.getElementById("batch-upload-modal").style.display =
                    "none";
                document.body.style.overflow = "auto";
            }

            // Handle batch upload form submission
            document
                .getElementById("batch-upload-form")
                .addEventListener("submit", async function (e) {
                    e.preventDefault();

                    const fileInput = document.getElementById("csv-file");
                    const file = fileInput.files[0];

                    if (!file) {
                        alert("Please select a CSV file");
                        return;
                    }

                    if (!file.name.endsWith(".csv")) {
                        alert("Please select a valid CSV file");
                        return;
                    }

                    try {
                        const uploadBtn = document.getElementById("upload-btn");
                        const progressDiv =
                            document.getElementById("upload-progress");
                        const progressBar =
                            document.getElementById("progress-bar");
                        const statusText =
                            document.getElementById("upload-status");

                        uploadBtn.disabled = true;
                        uploadBtn.textContent = "Processing...";
                        progressDiv.style.display = "block";
                        statusText.textContent = "Reading CSV file...";
                        progressBar.style.width = "20%";

                        // Read CSV file
                        const csvText = await readFileAsText(file);
                        console.log(
                            "CSV content preview:",
                            csvText.substring(0, 500),
                        );

                        const riddlesData = parseCSV(csvText);
                        console.log("Parsed riddles:", riddlesData);

                        if (riddlesData.length === 0) {
                            throw new Error(
                                "No valid riddles found in CSV file. Check console for parsing details.",
                            );
                        }

                        statusText.textContent = `Processing ${riddlesData.length} riddles...`;
                        progressBar.style.width = "50%";

                        // Send to backend
                        const response = await apiRequest(
                            "/api/admin/riddles/batch-upload",
                            {
                                method: "POST",
                                body: JSON.stringify({ riddles: riddlesData }),
                            },
                        );

                        progressBar.style.width = "100%";
                        statusText.textContent = "Upload completed!";

                        setTimeout(() => {
                            if (response.errorCount > 0) {
                                alert(
                                    `Upload completed: ${response.successCount} successful, ${response.errorCount} failed.\nCheck console for details.`,
                                );
                                console.log(
                                    "Upload results:",
                                    response.results,
                                );
                            } else {
                                alert(
                                    `Successfully uploaded ${response.successCount} riddles!`,
                                );
                            }
                            closeBatchUploadModal();
                            refreshRiddles();
                        }, 500);
                    } catch (error) {
                        console.error("Error uploading CSV:", error);
                        alert("Failed to upload riddles: " + error.message);
                    } finally {
                        const uploadBtn = document.getElementById("upload-btn");
                        uploadBtn.disabled = false;
                        uploadBtn.textContent = "Upload Riddles";
                    }
                });

            // Helper function to read file as text
            function readFileAsText(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = (e) =>
                        reject(new Error("Failed to read file"));
                    reader.readAsText(file);
                });
            }

            // CSV parsing function
            function parseCSV(csvText) {
                const lines = csvText.split("\n").filter((line) => line.trim());
                const riddles = [];

                console.log(`Processing ${lines.length} lines from CSV`);

                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;

                    console.log(`Processing line ${i + 1}: "${line}"`);

                    try {
                        // Try advanced parsing first
                        let values = parseCSVLine(line);

                        // If that fails, try simple split
                        if (values.length < 12) {
                            console.log(
                                `Advanced parsing gave ${values.length} values, trying simple split...`,
                            );
                            values = line
                                .split(",")
                                .map((v) => v.trim().replace(/^"|"$/g, ""));

                            // Pad with empty strings if needed
                            while (values.length < 12) {
                                values.push("");
                            }
                        }

                        console.log(
                            `Final parsed ${values.length} values:`,
                            values,
                        );

                        if (values.length < 12) {
                            console.warn(
                                `Row ${i + 1}: Still invalid format (${values.length} columns, expected 12)`,
                            );
                            continue;
                        }

                        const [
                            contentChinese,
                            contentEnglish,
                            answer,
                            hintChinese,
                            hintEnglish,
                            option1,
                            option2,
                            option3,
                            option4,
                            imageUrl,
                            winReward,
                            participationReward,
                        ] = values;

                        // Clean and validate required fields
                        const cleanChinese = contentChinese
                            ? contentChinese.trim()
                            : "";
                        const cleanEnglish = contentEnglish
                            ? contentEnglish.trim()
                            : "";
                        const cleanAnswer = answer ? answer.trim() : "";
                        const cleanOption1 = option1 ? option1.trim() : "";
                        const cleanOption2 = option2 ? option2.trim() : "";
                        const cleanOption3 = option3 ? option3.trim() : "";
                        const cleanOption4 = option4 ? option4.trim() : "";

                        console.log(`Row ${i + 1} field validation:`, {
                            cleanChinese: `"${cleanChinese}" (${cleanChinese.length} chars)`,
                            cleanEnglish: `"${cleanEnglish}" (${cleanEnglish.length} chars)`,
                            cleanAnswer: `"${cleanAnswer}"`,
                            options: [
                                cleanOption1,
                                cleanOption2,
                                cleanOption3,
                                cleanOption4,
                            ],
                        });

                        if (
                            !cleanChinese ||
                            !cleanEnglish ||
                            !cleanAnswer ||
                            !cleanOption1 ||
                            !cleanOption2 ||
                            !cleanOption3 ||
                            !cleanOption4
                        ) {
                            console.warn(
                                `Row ${i + 1}: Missing required fields`,
                            );
                            console.warn(
                                `Missing: Chinese=${!cleanChinese}, English=${!cleanEnglish}, Answer=${!cleanAnswer}, Opt1=${!cleanOption1}, Opt2=${!cleanOption2}, Opt3=${!cleanOption3}, Opt4=${!cleanOption4}`,
                            );
                            continue;
                        }

                        // Content length validation
                        if (
                            cleanChinese.length < 20 ||
                            cleanChinese.length > 100
                        ) {
                            console.warn(
                                `Row ${i + 1}: Chinese content length invalid (${cleanChinese.length} chars, need 20-100). Content: "${cleanChinese}"`,
                            );
                            continue;
                        }

                        if (
                            cleanEnglish.length < 20 ||
                            cleanEnglish.length > 100
                        ) {
                            console.warn(
                                `Row ${i + 1}: English content length invalid (${cleanEnglish.length} chars, need 20-100). Content: "${cleanEnglish}"`,
                            );
                            continue;
                        }

                        const winRewardNum = parseInt(winReward);
                        const participationRewardNum =
                            parseInt(participationReward);

                        if (
                            isNaN(winRewardNum) ||
                            winRewardNum < 5 ||
                            winRewardNum > 50
                        ) {
                            console.warn(
                                `Row ${i + 1}: Invalid win reward (must be 5-50)`,
                            );
                            continue;
                        }

                        if (
                            isNaN(participationRewardNum) ||
                            participationRewardNum < 3 ||
                            participationRewardNum > 5
                        ) {
                            console.warn(
                                `Row ${i + 1}: Invalid participation reward (must be 3-5)`,
                            );
                            continue;
                        }

                        riddles.push({
                            contentChinese: cleanChinese,
                            contentEnglish: cleanEnglish,
                            answer: cleanAnswer,
                            hintChinese: hintChinese
                                ? hintChinese.trim()
                                : null,
                            hintEnglish: hintEnglish
                                ? hintEnglish.trim()
                                : null,
                            optionsEnglish: [
                                cleanOption1,
                                cleanOption2,
                                cleanOption3,
                                cleanOption4,
                            ],
                            imageUrl: imageUrl ? imageUrl.trim() : null,
                            winReward: winRewardNum,
                            participationReward: participationRewardNum,
                            duration: 172800,
                        });
                    } catch (error) {
                        console.warn(
                            `Row ${i + 1}: Parse error - ${error.message}`,
                        );
                        console.warn(`Raw line: "${line}"`);
                    }
                }

                console.log(
                    `Final result: ${riddles.length} valid riddles parsed`,
                );
                return riddles;
            }

            // Parse a single CSV line handling quoted values
            function parseCSVLine(line) {
                // Simple but robust CSV parsing
                const result = [];
                let current = "";
                let inQuotes = false;
                let i = 0;

                while (i < line.length) {
                    const char = line[i];

                    if (char === '"') {
                        if (inQuotes) {
                            // Check for escaped quote
                            if (i + 1 < line.length && line[i + 1] === '"') {
                                current += '"';
                                i += 2;
                                continue;
                            } else {
                                inQuotes = false;
                            }
                        } else {
                            inQuotes = true;
                        }
                    } else if (char === "," && !inQuotes) {
                        result.push(current);
                        current = "";
                    } else {
                        current += char;
                    }
                    i++;
                }

                result.push(current);

                // Ensure we have exactly 12 fields by padding with empty strings
                while (result.length < 12) {
                    result.push("");
                }

                return result;
            }

            // Close modal when clicking outside
            window.onclick = function (event) {
                const riddleModal = document.getElementById("riddle-modal");
                const batchModal =
                    document.getElementById("batch-upload-modal");

                if (event.target === riddleModal) {
                    closeModal();
                } else if (event.target === batchModal) {
                    closeBatchUploadModal();
                }
            };

            // Handle escape key to close modals
            document.addEventListener("keydown", function (event) {
                if (event.key === "Escape") {
                    const riddleModal = document.getElementById("riddle-modal");
                    const batchModal =
                        document.getElementById("batch-upload-modal");

                    if (riddleModal.style.display === "flex") {
                        closeModal();
                    } else if (batchModal.style.display === "flex") {
                        closeBatchUploadModal();
                    }
                }
            });

            function closeImportModal() {
                document.getElementById("import-modal").style.display = "none";
            }

            function addPuzzle(event) {
                event.preventDefault();
                if (activePuzzles >= 2) return;

                activePuzzles++;
                updatePuzzleLimit();
                closeAddPuzzleModal();
                event.target.reset();
                alert("Puzzle added successfully!");
            }

            function importCSV(event) {
                event.preventDefault();
                if (activePuzzles >= 2) return;

                activePuzzles++;
                updatePuzzleLimit();
                closeImportModal();
                alert("CSV imported successfully!");
            }

            // Update puzzle limit display and button state
            function updatePuzzleLimit() {
                const activePuzzlesBadge = document.getElementById(
                    "active-puzzles-badge",
                );
                const addPuzzleBtn = document.getElementById("add-puzzle-btn");
                const limitWarning = document.getElementById("limit-warning");

                if (activePuzzlesBadge) {
                    activePuzzlesBadge.textContent = `Active Puzzles: ${activePuzzles}/2`;
                }

                if (addPuzzleBtn) {
                    if (activePuzzles >= 2) {
                        addPuzzleBtn.disabled = true;
                        addPuzzleBtn.textContent = "Limit Reached";
                    } else {
                        addPuzzleBtn.disabled = false;
                        addPuzzleBtn.textContent = "+Add Puzzle";
                    }
                }

                if (limitWarning) {
                    limitWarning.style.display =
                        activePuzzles >= 2 ? "block" : "none";
                }
            }

            // Delete riddle function
            async function deleteRiddle(riddleId) {
                if (!confirm("Are you sure you want to delete this riddle?")) {
                    return;
                }

                try {
                    const response = await fetch(
                        `/api/admin/riddles/${riddleId}`,
                        {
                            method: "DELETE",
                        },
                    );
                    const data = await response.json();

                    if (data.success) {
                        refreshRiddles();
                    } else {
                        alert("Failed to delete riddle: " + data.error);
                    }
                } catch (error) {
                    console.error("Error deleting riddle:", error);
                    alert("Error deleting riddle");
                }
            }

            // Edit riddle function (placeholder)
            function editRiddle(riddleId) {
                alert("Edit functionality not implemented yet");
            }

            // Load reward rates
            async function loadRewardRates() {
                try {
                    const data = await apiRequest("/api/admin/reward-settings");

                    if (data.success) {
                        displayRewardSettings(data.settings);
                    } else {
                        console.error(
                            "Failed to load reward settings:",
                            data.error,
                        );
                    }
                } catch (error) {
                    console.error("Failed to load reward settings:", error);
                }
            }

            // Display reward settings
            function displayRewardSettings(settings) {
                console.log("Reward settings loaded:", settings);

                // Populate form fields with current settings
                settings.forEach((setting) => {
                    switch (setting.settingKey) {
                        case "apy_30_day":
                            const apy30Input =
                                document.getElementById("apy-30-day");
                            if (apy30Input)
                                apy30Input.value = parseFloat(
                                    setting.settingValue,
                                );
                            break;
                        case "apy_90_day":
                            const apy90Input =
                                document.getElementById("apy-90-day");
                            if (apy90Input)
                                apy90Input.value = parseFloat(
                                    setting.settingValue,
                                );
                            break;
                        case "apy_180_day":
                            const apy180Input =
                                document.getElementById("apy-180-day");
                            if (apy180Input)
                                apy180Input.value = parseFloat(
                                    setting.settingValue,
                                );
                            break;
                        case "participation_10d":
                            const part10Input =
                                document.getElementById("participation-10d");
                            if (part10Input)
                                part10Input.value = parseFloat(
                                    setting.settingValue,
                                );
                            break;
                        case "participation_30d":
                            const part30Input =
                                document.getElementById("participation-30d");
                            if (part30Input)
                                part30Input.value = parseFloat(
                                    setting.settingValue,
                                );
                            break;
                    }
                });
            }

            // Load lock settings from database
            async function loadLockSettings() {
                try {
                    const data = await apiRequest("/api/admin/lock-settings");
                    if (data.success && data.settings) {
                        displayLockSettings(data.settings);
                    } else {
                        console.error(
                            "Failed to load lock settings:",
                            data.error,
                        );
                    }
                } catch (error) {
                    console.error("Failed to load lock settings:", error);
                }
            }

            // Display lock settings
            function displayLockSettings(settings) {
                console.log("Lock settings loaded:", settings);

                // Populate lock settings form fields
                settings.forEach((setting) => {
                    switch (setting.settingKey) {
                        case "lock_percentage":
                            const lockPctInput =
                                document.getElementById("lock-percentage");
                            if (lockPctInput)
                                lockPctInput.value = parseFloat(
                                    setting.settingValue,
                                );
                            break;
                        case "lock_days":
                            const lockDaysInput =
                                document.getElementById("lock-days");
                            if (lockDaysInput)
                                lockDaysInput.value = parseFloat(
                                    setting.settingValue,
                                );
                            break;
                    }
                });
            }

            // Load million pool settings from database
            async function loadMillionPoolSettings() {
                try {
                    const data = await apiRequest(
                        "/api/admin/million-pool/settings",
                    );
                    if (data.success && data.settings) {
                        displayMillionPoolSettings(data.settings);
                    } else {
                        console.error(
                            "Failed to load million pool settings:",
                            data.error,
                        );
                    }
                } catch (error) {
                    console.error(
                        "Failed to load million pool settings:",
                        error,
                    );
                }
            }

            // Display million pool settings
            function displayMillionPoolSettings(settings) {
                console.log("Million pool settings loaded:", settings);

                const activeToggle = document.getElementById(
                    "million-pool-active",
                );
                const distributionFrequency = document.getElementById(
                    "distribution-frequency",
                );
                const rewardAmountUsdt =
                    document.getElementById("reward-amount-usdt");
                const numberOfWinners =
                    document.getElementById("number-of-winners");
                const usdtRequirement =
                    document.getElementById("usdt-requirement");
                const shsyRequirement =
                    document.getElementById("shsy-requirement");

                if (activeToggle) activeToggle.checked = settings.isActive;
                if (distributionFrequency)
                    distributionFrequency.value =
                        settings.distributionFrequencyMinutes;
                if (rewardAmountUsdt)
                    rewardAmountUsdt.value = parseFloat(
                        settings.rewardAmountShsy,
                    );
                if (numberOfWinners)
                    numberOfWinners.value = settings.numberOfWinners;
                if (usdtRequirement)
                    usdtRequirement.value = parseFloat(
                        settings.usdtRequirement,
                    );
                if (shsyRequirement)
                    shsyRequirement.value = parseFloat(
                        settings.shsyRequirement,
                    );
            }

            // Update reward rates including lock settings and million pool
            async function updateRewardRates() {
                try {
                    const apy30Day = parseFloat(
                        document.getElementById("apy-30-day").value,
                    );
                    const apy90Day = parseFloat(
                        document.getElementById("apy-90-day").value,
                    );
                    const apy180Day = parseFloat(
                        document.getElementById("apy-180-day").value,
                    );
                    const participation30d = parseFloat(
                        document.getElementById("participation-30d").value,
                    );
                    const participation10d = parseFloat(
                        document.getElementById("participation-10d").value,
                    );

                    // Get simplified lock settings
                    const lockPercentage =
                        parseFloat(
                            document.getElementById("lock-percentage").value,
                        ) || 25;
                    const lockDays =
                        parseFloat(
                            document.getElementById("lock-days").value,
                        ) || 30;

                    // Get million pool settings
                    const millionPoolActive = document.getElementById(
                        "million-pool-active",
                    ).checked;
                    const distributionFrequency = parseInt(
                        document.getElementById("distribution-frequency").value,
                    );
                    const rewardAmountUsdt = parseFloat(
                        document.getElementById("reward-amount-usdt").value,
                    );
                    const numberOfWinners = parseInt(
                        document.getElementById("number-of-winners").value,
                    );
                    const usdtRequirement = parseFloat(
                        document.getElementById("usdt-requirement").value,
                    );
                    const shsyRequirement = parseFloat(
                        document.getElementById("shsy-requirement").value,
                    );

                    // Update reward settings
                    const rewardData = await apiRequest(
                        "/api/admin/reward-settings",
                        {
                            method: "POST",
                            body: JSON.stringify({
                                apy30Day,
                                apy90Day,
                                apy180Day,
                                participation30d,
                                participation10d,
                                lockPercentage,
                                lockDays,
                            }),
                        },
                    );

                    // Update million pool settings
                    const millionPoolData = await apiRequest(
                        "/api/admin/million-pool/settings",
                        {
                            method: "POST",
                            body: JSON.stringify({
                                isActive: millionPoolActive,
                                distributionFrequencyMinutes:
                                    distributionFrequency,
                                rewardAmountShsy: rewardAmountUsdt.toString(),
                                numberOfWinners,
                                usdtRequirement: usdtRequirement.toString(),
                                shsyRequirement: shsyRequirement.toString(),
                            }),
                        },
                    );

                    if (rewardData.success && millionPoolData.success) {
                        alert("All settings updated successfully!");
                    } else {
                        alert(
                            "Failed to update some settings. Please check the logs.",
                        );
                    }
                } catch (error) {
                    console.error("Error updating settings:", error);
                    alert("Error updating settings. Please try again.");
                }
            }

            // Initialize admin panel
            updatePuzzleLimit();
            loadAdminStats();
            loadLeaderboard();
            refreshRiddles();
            loadRewardRates();
            loadLockSettings();
            loadMillionPoolSettings();

            // Load leaderboard data
            async function loadLeaderboard() {
                try {
                    const response = await fetch("/api/leaderboard");
                    const data = await response.json();

                    if (data.success && data.leaderboard.length > 0) {
                        const leaderboardContent = document.getElementById(
                            "leaderboard-content",
                        );
                        leaderboardContent.innerHTML = "";

                        data.leaderboard.forEach((user) => {
                            const truncatedWallet =
                                user.walletAddress.substring(0, 4) +
                                "..." +
                                user.walletAddress.substring(
                                    user.walletAddress.length - 4,
                                );

                            const leaderboardItem =
                                document.createElement("div");
                            leaderboardItem.className = "leaderboard-item";
                            leaderboardItem.innerHTML = `
                            <span class="leaderboard-rank">#${user.rank}</span>
                            <div class="leaderboard-user">
                                <div class="leaderboard-name">Staker ${user.rank}</div>
                                <div class="leaderboard-wallet">${truncatedWallet}</div>
                            </div>
                            <div class="leaderboard-score">${parseFloat(user.totalStaked).toLocaleString()} SHSY<br><small>Stakes: ${user.activeStakes}</small></div>
                        `;
                            leaderboardContent.appendChild(leaderboardItem);
                        });
                    } else {
                        document.getElementById(
                            "leaderboard-content",
                        ).innerHTML = `
                        <div class="leaderboard-item">
                            <span class="leaderboard-rank">-</span>
                            <div class="leaderboard-user">
                                <div class="leaderboard-name">No stakers yet</div>
                                <div class="leaderboard-wallet">Start staking to appear here</div>
                            </div>
                            <div class="leaderboard-score">0 SHSY</div>
                        </div>
                    `;
                    }
                } catch (error) {
                    console.error("Error loading leaderboard:", error);
                    document.getElementById("leaderboard-content").innerHTML = `
                    <div class="leaderboard-item">
                        <span class="leaderboard-rank">-</span>
                        <div class="leaderboard-user">
                            <div class="leaderboard-name">Error loading data</div>
                            <div class="leaderboard-wallet">Please refresh the page</div>
                        </div>
                        <div class="leaderboard-score">- SHSY</div>
                    </div>
                `;
                }
            }

            window.onclick = function (event) {
                const addModal = document.getElementById("add-puzzle-modal");
                const importModal = document.getElementById("import-modal");
                if (event.target === addModal) {
                    closeAddPuzzleModal();
                }
                if (event.target === importModal) {
                    closeImportModal();
                }
            };
        </script>
    </body>
</html>
